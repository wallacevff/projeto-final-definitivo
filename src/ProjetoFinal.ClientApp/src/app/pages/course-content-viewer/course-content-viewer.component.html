<section class="content-viewer">
  <div class="content-viewer__header">
    <a class="back-link" [routerLink]="['/courses', courseId() ?? '' , 'manage']">
      ← Voltar para o curso
    </a>

    <h2>{{ pageTitle() }}</h2>
    <span class="status-badge" [attr.data-status]="statusLabel()">{{ statusLabel() }}</span>

    <p class="summary" *ngIf="content()?.Summary">{{ content()?.Summary }}</p>
  </div>

  <ng-container *ngIf="!loading(); else loadingState">
    <ng-container *ngIf="!error(); else errorState">
      <article class="content-card" *ngIf="content() as current">
        <section class="content-body">
          <h3>Descricao</h3>
          <p *ngIf="current.Body; else noBody">
            {{ current.Body }}
          </p>
          <ng-template #noBody>
            <p class="muted">Nenhuma descricao detalhada informada.</p>
          </ng-template>
        </section>

        <section class="attachments-section">
          <header>
            <h3>Anexos</h3>
            <span>{{ current.Attachments.length }} arquivo(s)</span>
          </header>

          <ng-container *ngIf="current.Attachments.length > 0; else noAttachments">
            <ul class="attachments-list">
              <li *ngFor="let attachment of current.Attachments">
                <div>
                  <strong>{{ attachment.Caption || 'Arquivo sem descricao' }}</strong>
                  <span class="tag" *ngIf="attachment.IsPrimary">Principal</span>
                  <p class="muted">{{ attachment.Media?.ContentType }} · {{ attachment.Media?.OriginalFileName }}</p>
                </div>

                <ng-container *ngIf="isVideoAttachment(attachment); else downloadBlock">
                  <div class="video-container">
                    <button
                      class="button button--primary"
                      type="button"
                      *ngIf="!isVideoLoaded(attachment.MediaResourceId)"
                      (click)="loadVideo(attachment)"
                      [disabled]="videoIsLoading(attachment.MediaResourceId)"
                    >
                      {{ videoIsLoading(attachment.MediaResourceId) ? 'Carregando...' : 'Carregar vídeo' }}
                    </button>

                    <div class="video-frame" *ngIf="videoUrlFor(attachment.MediaResourceId) as videoUrl">
                      <video #videoPlayer controls [src]="videoUrl"></video>

                      <div class="annotation-panel">
                        <h4>Anotações</h4>
                        <div class="annotation-form">
                          <input
                            type="text"
                            placeholder="Mensagem"
                            [value]="annotationDraft(attachment.MediaResourceId)"
                            (input)="updateAnnotationDraft(attachment.MediaResourceId, ($any($event.target).value || ''))"
                          />
                          <button
                            type="button"
                            class="button button--ghost"
                            (click)="addAnnotation(attachment.MediaResourceId, videoPlayer.currentTime)"
                          >
                            Adicionar ({{ formatTime(videoPlayer.currentTime) }})
                          </button>
                        </div>

                        <ul class="annotation-list" *ngIf="annotationsFor(attachment.MediaResourceId).length; else noAnnotations">
                          <li
                            *ngFor="let annotation of annotationsFor(attachment.MediaResourceId)"
                            (click)="seekTo(videoPlayer, annotation.time)"
                          >
                            <span>{{ formatTime(annotation.time) }}</span>
                            <p>{{ annotation.text }}</p>
                          </li>
                        </ul>
                        <ng-template #noAnnotations>
                          <p class="muted">Nenhuma anotação criada ainda.</p>
                        </ng-template>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <ng-template #downloadBlock>
                  <button
                    class="button button--ghost"
                    type="button"
                    (click)="downloadAttachment(attachment)"
                    [disabled]="downloading() === attachment.MediaResourceId"
                  >
                    {{ downloading() === attachment.MediaResourceId ? 'Baixando...' : 'Baixar' }}
                  </button>
                </ng-template>
              </li>
            </ul>
          </ng-container>
          <ng-template #noAttachments>
            <p class="muted">Nenhum arquivo foi anexado a este conteudo.</p>
          </ng-template>
        </section>
      </article>
    </ng-container>
  </ng-container>
</section>

<ng-template #loadingState>
  <div class="state state--info">Carregando conteudo...</div>
</ng-template>

<ng-template #errorState>
  <div class="state state--error">{{ error() }}</div>
</ng-template>
